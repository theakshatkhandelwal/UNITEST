{% extends "base.html" %}

{% block title %}Take Quiz - {{ quiz.title }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">{{ quiz.title }}</h2>
    <span class="badge bg-secondary">Code: {{ quiz.code }}</span>
  </div>

  {% if quiz.duration_minutes %}
  <div class="alert alert-info d-flex justify-content-between align-items-center">
    <div>
      <i class="fas fa-hourglass-half me-2"></i>Time limit: {{ quiz.duration_minutes }} minutes
    </div>
    <div><strong id="countdown"></strong></div>
  </div>
  {% endif %}

  <!-- Fullscreen Gate - Always Visible -->
  <div id="fs-gate" style="position:fixed;inset:0;background:rgba(0,0,0,0.9);color:#fff;z-index:9999;display:flex;align-items:center;justify-content:center;">
    <div style="text-align:center;max-width:520px;padding:16px;">
      <h3 class="mb-3">ðŸ”’ Enter Fullscreen to Start Quiz</h3>
      <p class="mb-3">You must be in fullscreen mode to take this test.</p>
      <p class="mb-3">Exiting fullscreen will end your session.</p>
      <button class="btn btn-primary btn-lg" onclick="startQuiz()">
        Enter Fullscreen & Start
      </button>
    </div>
  </div>

  <form id="quizForm" method="POST" action="{{ url_for('submit_shared_quiz', code=quiz.code) }}" style="display:none;">
    <input type="hidden" name="fullscreen_exit" id="fullscreen_exit_flag" value="false">
    <div class="card">
      <div class="card-body">
        {% for q in questions %}
          <div class="mb-4" data-question-id="{{ q.id }}">
            <h5 class="fw-bold">Q{{ loop.index }}. {{ q.question }}</h5>
            {% if q.qtype == 'mcq' %}
              {% for opt in q.options %}
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="q_{{ q.id }}" value="{{ opt }}" id="q{{ q.id }}_{{ loop.index }}">
                  <label class="form-check-label" for="q{{ q.id }}_{{ loop.index }}">{{ opt }}</label>
                </div>
              {% endfor %}
            {% else %}
              <textarea class="form-control" name="q_{{ q.id }}" rows="3" placeholder="Your answer..."></textarea>
            {% endif %}
            <small class="text-muted">Marks: {{ q.marks }}</small>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="mt-3 d-flex gap-2">
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Cancel</a>
      <button class="btn btn-primary" type="submit">Submit</button>
    </div>
  </form>
</div>

<script>
// Inline JavaScript - runs immediately
let timerInterval = null;
let quizStarted = false;

function startQuiz() {
  console.log('Starting quiz...');
  
  // Try to enter fullscreen
  const elem = document.documentElement;
  if (elem.requestFullscreen) {
    elem.requestFullscreen().then(() => {
      console.log('Entered fullscreen');
      showQuiz();
    }).catch(err => {
      console.error('Fullscreen failed:', err);
      alert('Could not enter fullscreen. Please allow fullscreen and try again.');
    });
  } else if (elem.webkitRequestFullscreen) {
    elem.webkitRequestFullscreen();
    showQuiz();
  } else if (elem.msRequestFullscreen) {
    elem.msRequestFullscreen();
    showQuiz();
  } else {
    console.log('No fullscreen support');
    showQuiz();
  }
}

function showQuiz() {
  quizStarted = true;
  document.getElementById('quizForm').style.display = '';
  document.getElementById('fs-gate').remove();
  startTimer();
}

function startTimer() {
  const minutes = {{ quiz.duration_minutes or 'null' }};
  if (!minutes) return;
  
  console.log('Starting timer for', minutes, 'minutes');
  const endTime = Date.now() + (minutes * 60 * 1000);
  const countdownEl = document.getElementById('countdown');
  
  timerInterval = setInterval(() => {
    const remaining = endTime - Date.now();
    if (remaining <= 0) {
      console.log('Time up! Auto-submitting');
      clearInterval(timerInterval);
      document.getElementById('quizForm').submit();
      return;
    }
    
    const mins = Math.floor(remaining / 60000);
    const secs = Math.floor((remaining % 60000) / 1000);
    if (countdownEl) {
      countdownEl.textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
    }
  }, 1000);
}

function exitQuiz() {
  console.log('Exiting quiz - logging out');
  document.getElementById('fullscreen_exit_flag').value = 'true';
  
  // Collect answers and send
  const answers = {};
  document.querySelectorAll('[data-question-id]').forEach(block => {
    const qid = block.getAttribute('data-question-id');
    const radio = block.querySelector('input[type="radio"]:checked');
    const textarea = block.querySelector('textarea');
    let val = '';
    if (radio) val = radio.value;
    if (textarea) val = textarea.value || val;
    answers['q_' + qid] = val;
  });
  
  try {
    navigator.sendBeacon('{{ url_for('auto_submit_partial', code=quiz.code) }}', 
      new Blob([JSON.stringify(answers)], {type: 'application/json'}));
  } catch(e) {
    console.error('Failed to send answers:', e);
  }
  
  window.location.href = '/logout';
}

// Monitor fullscreen changes
document.addEventListener('fullscreenchange', function() {
  if (!document.fullscreenElement && quizStarted) {
    console.log('Exited fullscreen');
    exitQuiz();
  }
});

document.addEventListener('webkitfullscreenchange', function() {
  if (!document.webkitFullscreenElement && quizStarted) {
    console.log('Exited webkit fullscreen');
    exitQuiz();
  }
});

document.addEventListener('msfullscreenchange', function() {
  if (!document.msFullscreenElement && quizStarted) {
    console.log('Exited ms fullscreen');
    exitQuiz();
  }
});

// Disable copy/paste
document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'a' || e.key === 'v')) {
    e.preventDefault();
  }
});

// Disable text selection
document.body.style.userSelect = 'none';
document.body.style.webkitUserSelect = 'none';
document.body.style.mozUserSelect = 'none';
document.body.style.msUserSelect = 'none';
</script>

<style>
/* Disable selection/copy */
* { 
  -webkit-user-select: none; 
  -ms-user-select: none; 
  user-select: none; 
}
body { 
  -webkit-touch-callout: none; 
}
</style>
{% endblock %}